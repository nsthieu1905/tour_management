# âœ… SETUP CHECKLIST - REALTIME MESSAGING SYSTEM

## ğŸ“¦ Cáº¥u trÃºc files Ä‘Ã£ táº¡o:

### Backend:
1. **[src/app/API/MessageApiController.js](src/app/API/MessageApiController.js)** - 10 static methods
   - `sendMessage()` - Gá»­i tin + **broadcast socket** âœ¨
   
2. **[src/index.js](src/index.js)** - Socket.io handlers
   - `conversation:join` - Join vÃ o room phÃ²ng chat
   - `conversation:leave` - Rá»i khá»i room
   - `typing:start/stop` - Typing indicator
   - `message:read` - ÄÃ¡nh dáº¥u Ä‘Ã£ Ä‘á»c

### Frontend:

**Client (KhÃ¡ch hÃ ng):**
- [src/public/client/js/chatbox-realtime.js](src/public/client/js/chatbox-realtime.js) - Class `RealtimeMessagingClient`
  - Auto join socket khi má»Ÿ chat
  - Listen `message:new`, `typing:*` events
  - Send message vá»›i realtime broadcast

**Admin (NhÃ¢n viÃªn):**
- [src/public/admin/js/admin-chat-realtime.js](src/public/admin/js/admin-chat-realtime.js) - Class `AdminRealtimeMessaging`
  - Join Táº¤T Cáº¢ conversation rooms (váº¡n nÄƒng ğŸ‘‘)
  - Load danh sÃ¡ch cuá»™c há»™i thoáº¡i
  - Realtime message update
  - Typing indicator + mark as read

### Views:
- ThÃªm script vÃ o layouts (done âœ…)
  - admin: `/admin/js/admin-chat-realtime.js`
  - client: `/client/js/chatbox-realtime.js`

---

## ğŸš€ CÃC BÆ¯á»šC SETUP CUá»I CÃ™NG:

### Step 1: Storage User ID cho Client
Khi user login, lÆ°u `userId` vÃ o localStorage:

```javascript
// src/public/client/js/auth.js (thÃªm vÃ o sau khi login thÃ nh cÃ´ng)
localStorage.setItem("userId", response.data.user._id);
```

Hoáº·c thÃªm vÃ o HTML body:
```handlebars
<!-- src/resources/client/views/layouts/main.hbs -->
<body {{#if user}}data-user-id="{{user._id}}"{{/if}}>
```

### Step 2: Admin ID cho Admin  
TÆ°Æ¡ng tá»± vá»›i admin:

```javascript
// src/public/admin/js/auth.js (thÃªm sau login)
localStorage.setItem("adminId", response.data.admin._id);
```

Hoáº·c thÃªm vÃ o HTML:
```handlebars
<!-- src/resources/admin/views/partials/header_admin.hbs -->
<div data-admin-id="{{adminId}}">
```

### Step 3: Kiá»ƒm tra View Handlebars
Äáº£m báº£o cÃ¡c ID Ä‘Ã£ cÃ³ trong DOM:
- Client: `#chatWindow`, `#open-mesage`, `#chatInput`, `#sendChatBtn`, `#chatMessages`
- Admin: `#conversationsList`, `#messagesContainer`, `#messageForm`, `#messageInput`

### Step 4: Test Realtime Chat

**Client Side:**
```bash
# Má»Ÿ console -> LocalStorage
localStorage.setItem("userId", "test-user-123")

# Sau Ä‘Ã³ reload, má»Ÿ chat window
# Sáº½ tháº¥y: "[Chat] Socket connected"
```

**Admin Side:**
```bash
# Admin page console:
localStorage.setItem("adminId", "admin-456")

# Reload admin chat page
# Sáº½ tháº¥y: "[Admin Chat] Socket connected"
```

**Test Message:**
1. Má»Ÿ client chat â†’ gá»­i tin "Hello"
2. Check database (Message collection) â†’ lÆ°u Ä‘Æ°á»£c tin
3. Admin page â†’ nháº­n tin realtime (khÃ´ng cáº§n F5)
4. Admin gá»­i tin â†’ Client nháº­n ngay
5. Typing indicator â†’ tháº¥y "Admin Ä‘ang gÃµ..."

---

## ğŸ¯ FLOW HOáº T Äá»˜NG:

```
CLIENT LOGIN
    â†“
[LÆ°u userId: localStorage.setItem("userId", user._id)]
    â†“
Má»Ÿ chat window
    â†“
Socket emit "conversation:join" {conversationId, userId}
    â†“
Server: socket.join(`conversation:{id}`)
    â†“
Gá»­i tin: POST /api/messages/send
    â†“
Backend: save DB + broadcast io.to(`conversation:{id}`).emit("message:new")
    â†“
Client/Admin socket láº¯ng nghe "message:new"
    â†“
HIá»‚N THá»Š Tá»¨C THá»œI âœ¨

---

ADMIN LOGIN
    â†“
[LÆ°u adminId: localStorage.setItem("adminId", admin._id)]
    â†“
Load danh sÃ¡ch cuá»™c há»™i thoáº¡i
    â†“
Admin join Táº¤T Cáº¢ conversation rooms
    â†“
Khi cÃ³ cuá»™c má»›i â†’ Admin tá»± Ä‘á»™ng join
    â†“
Client + Admin trong cÃ¹ng room {id}
    â†“
User A chá»‰ nháº­n tin tá»« room cá»§a mÃ¬nh
    â†“
Admin nghe Ä‘Æ°á»£c Táº¤T Cáº¢ (vÃ¬ á»Ÿ Táº¤T Cáº¢ room)
```

---

## âš™ï¸ SOCKET EVENTS TÃ“MERIZE:

### Client â†’ Server:
- `conversation:join` - Join room
- `conversation:leave` - Leave room
- `typing:start` - Báº¯t Ä‘áº§u gÃµ
- `typing:stop` - Dá»«ng gÃµ
- `message:read` - Tin Ä‘Ã£ Ä‘á»c

### Server â†’ Client/Admin (broadcast):
- `message:new` - Tin nháº¯n má»›i
- `typing:active` - NgÆ°á»i kia Ä‘ang gÃµ
- `typing:inactive` - NgÆ°á»i kia dá»«ng gÃµ
- `conversation:update` - Update lastMessage
- `conversation:closed` - Cuá»™c bá»‹ Ä‘Ã³ng

---

## ğŸ› DEBUG TIPS:

**Console Admin:**
```javascript
// Kiá»ƒm tra socket
window.adminChat.socket

// Check conversations loaded
window.adminChat.conversations

// Check current conversation
window.adminChat.currentConversationId

// Manual send message
window.adminChat.sendMessage()
```

**Console Client:**
```javascript
// Kiá»ƒm tra socket
window.realtimeChat.socket

// Check conversation
window.realtimeChat.currentConversationId

// Manual emit
window.realtimeChat.socket.emit("typing:start", {...})
```

---

## ğŸ“‹ CHECKLIST TRÆ¯á»šC RELEASE:

- [ ] User login lÆ°u userId
- [ ] Admin login lÆ°u adminId
- [ ] Database Conversation & Message models âœ…
- [ ] Backend API endpoints âœ…
- [ ] Socket.io setup âœ…
- [ ] Client realtime script âœ…
- [ ] Admin realtime script âœ…
- [ ] Test message gá»­i/nháº­n
- [ ] Test typing indicator
- [ ] Test mark as read
- [ ] Test admin join all rooms
- [ ] Test conversation close

---

## ğŸ‰ DONE! 

BÃ¢y giá» báº¡n cÃ³ má»™t há»‡ thá»‘ng chat realtime hoÃ n chá»‰nh:
- âœ… Room-based messaging (User A â†” Admin, User B â†” Admin, nhÆ°ng A khÃ´ng tháº¥y B)
- âœ… Real-time broadcast via Socket.io
- âœ… Typing indicator
- âœ… Mark as read
- âœ… Conversation management (join/leave/close)
- âœ… Admin "váº¡n nÄƒng" - vÃ o Ä‘Æ°á»£c Táº¤T Cáº¢ room

Giá»‘ng nhÆ° tá»•ng Ä‘Ã i Ä‘iá»‡n thoáº¡i: NhÃ¢n viÃªn nghe Ä‘Æ°á»£c nhiá»u line, nhÆ°ng khÃ¡ch hÃ ng chá»‰ nghe Ä‘Æ°á»£c line cá»§a mÃ¬nh! ğŸ“
