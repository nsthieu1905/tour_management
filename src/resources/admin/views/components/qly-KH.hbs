<div class="flex pt-16">
  <main class="flex-1 ml-64 p-6">
    <!-- Customers Section -->
    <div id="customers" class="section">
      <div class="flex justify-between items-center mb-6">
        <div>
          <h2 class="text-3xl font-bold text-gray-900 mb-2">
            Quản lý Khách hàng
          </h2>
          <p class="text-gray-600">Theo dõi thông tin và hành vi khách hàng</p>
        </div>
        <button
          class="gradient-bg text-white px-6 py-3 rounded-lg hover:opacity-90 transition-opacity"
        >
          <i class="fas fa-envelope mr-2"></i>Gửi Email Marketing
        </button>
      </div>

      <!-- Customer Stats -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="bg-white p-6 rounded-xl shadow-sm">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm font-medium text-gray-600">Tổng khách hàng</p>
              <p class="text-2xl font-bold text-gray-900" id="totalCustomers">
                0
              </p>
            </div>
            <div class="bg-blue-100 p-3 rounded-full">
              <i class="fas fa-users text-blue-600"></i>
            </div>
          </div>
        </div>

        <div class="bg-white p-6 rounded-xl shadow-sm">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm font-medium text-gray-600">
                Khách hàng kim cương
              </p>
              <p class="text-2xl font-bold text-gray-900" id="diamondCustomers">
                0
              </p>
            </div>
            <div class="bg-yellow-100 p-3 rounded-full">
              <i class="fas fa-crown text-yellow-600"></i>
            </div>
          </div>
        </div>

        <div class="bg-white p-6 rounded-xl shadow-sm">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm font-medium text-gray-600">Khách mới</p>
              <p class="text-2xl font-bold text-gray-900" id="newCustomers">
                0
              </p>
            </div>
            <div class="bg-green-100 p-3 rounded-full">
              <i class="fas fa-user-plus text-green-600"></i>
            </div>
          </div>
        </div>

        <div class="bg-white p-6 rounded-xl shadow-sm">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm font-medium text-gray-600">Tỷ lệ quay lại</p>
              <p class="text-2xl font-bold text-gray-900" id="returnRate">0%</p>
            </div>
            <div class="bg-purple-100 p-3 rounded-full">
              <i class="fas fa-redo text-purple-600"></i>
            </div>
          </div>
        </div>
      </div>

      <!-- Customer Filters -->
      <div class="bg-white p-4 rounded-xl shadow-sm mb-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <select
            id="segmentFilter"
            class="border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500"
          >
            <option value="all">Tất cả phân khúc</option>
            <option value="Kim cương">Kim Cương</option>
            <option value="Vàng">Vàng</option>
            <option value="Bạc">Bạc</option>
            <option value="Khách mới">Khách mới</option>
          </select>

          <input
            type="text"
            id="searchInput"
            placeholder="Tìm theo tên, email, SĐT..."
            class="border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500"
          />

          <button
            id="resetFilter"
            class="bg-gray-300 text-gray-900 px-4 py-2 rounded-lg hover:bg-gray-400 transition"
          >
            <i class="fas fa-redo mr-2"></i>Làm mới
          </button>
        </div>
      </div>

      <!-- Customer List -->
      <div class="bg-white rounded-xl shadow-sm overflow-hidden">
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="border-b border-gray-200">
              <tr>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Khách hàng
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Phân loại
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Số tour đã đặt
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Tổng chi tiêu
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Lần cuối đặt
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Thao tác
                </th>
              </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200" id="customerList">
              <!-- Customer rows will be populated here -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- Pagination -->
      <div class="mt-6 flex justify-center gap-2" id="pagination">
        <!-- Pagination buttons will be populated here -->
      </div>
    </div>
  </main>
</div>

<script>
  let currentPage = 1;
  let currentSegment = "all";
  let currentSearch = "";
  let allCustomers = [];

  const API_BASE = "/api/users";

  // Format currency
  const formatCurrency = (amount) => {
    return new Intl.NumberFormat("vi-VN", {
      style: "currency",
      currency: "VND",
    }).format(amount);
  };

  // Format date
  const formatDate = (dateString) => {
    if (!dateString) return "Chưa có";
    const date = new Date(dateString);
    return date.toLocaleDateString("vi-VN");
  };

  // Get customer type badge
  const getCustomerTypeBadge = (type) => {
    const badgeMap = {
      "Kim cương": {
        class: "bg-yellow-100 text-yellow-800",
        icon: "fas fa-crown",
      },
      Vàng: { class: "bg-orange-100 text-orange-800", icon: "fas fa-gem" },
      Bạc: { class: "bg-gray-200 text-gray-800", icon: "fas fa-coins" },
      "Khách mới": {
        class: "bg-green-100 text-green-800",
        icon: "fas fa-star",
      },
    };

    const config = badgeMap[type] || badgeMap["Khách mới"];
    return `
    <span class="px-2 py-1 text-xs font-medium rounded-full ${config.class}">
      <i class="${config.icon} mr-1"></i>${type}
    </span>
  `;
  };

  // Get initials for avatar
  const getInitials = (fullName) => {
    return fullName
      .split(" ")
      .map((n) => n[0])
      .join("")
      .toUpperCase()
      .substring(0, 2);
  };

  // Get avatar color
  const getAvatarColor = (index) => {
    const colors = [
      "#667eea",
      "#764ba2",
      "#f093fb",
      "#4facfe",
      "#00f2fe",
      "#43e97b",
      "#fa709a",
      "#fee140",
    ];
    return colors[index % colors.length];
  };

  // Load stats
  const loadStats = async () => {
    try {
      const response = await fetch(`${API_BASE}/customers/stats`);
      const result = await response.json();

      if (result.success) {
        const stats = result.data;
        document.getElementById("totalCustomers").textContent =
          stats.totalCustomers;
        document.getElementById("diamondCustomers").textContent =
          stats.diamondCustomers;
        document.getElementById("newCustomers").textContent =
          stats.newCustomers;
        document.getElementById("returnRate").textContent =
          stats.returnRate + "%";
      }
    } catch (error) {
      console.error("Error loading stats:", error);
    }
  };

  // Load customers
  const loadCustomers = async (page = 1, segment = "all", search = "") => {
    try {
      let url = `${API_BASE}/customers?page=${page}&limit=10`;
      if (segment !== "all") {
        url += `&segment=${segment}`;
      }

      const response = await fetch(url);
      const result = await response.json();

      if (result.success) {
        let customers = result.data;

        // Filter by search
        if (search) {
          customers = customers.filter(
            (c) =>
              c.fullName.toLowerCase().includes(search.toLowerCase()) ||
              c.email.toLowerCase().includes(search.toLowerCase()) ||
              (c.phone && c.phone.includes(search))
          );
        }

        allCustomers = customers;
        renderCustomers(customers);
        renderPagination(
          result.pagination.page,
          result.pagination.pages,
          result.pagination.total
        );
      }
    } catch (error) {
      console.error("Error loading customers:", error);
    }
  };

  // Render customers
  const renderCustomers = (customers) => {
    const customerList = document.getElementById("customerList");
    customerList.innerHTML = "";

    if (customers.length === 0) {
      customerList.innerHTML = `
      <tr>
        <td colspan="6" class="px-6 py-8 text-center text-gray-500">
          <i class="fas fa-inbox text-3xl mb-2"></i>
          <p>Không có khách hàng nào</p>
        </td>
      </tr>
    `;
      return;
    }

    customers.forEach((customer, index) => {
      const initials = getInitials(customer.fullName);
      const avatarColor = getAvatarColor(index);

      const row = `
      <tr class="hover:bg-gray-50 cursor-pointer transition" onclick="viewCustomerDetail('${
        customer._id
      }')">
        <td class="px-6 py-4 whitespace-nowrap">
          <div class="flex items-center">
            <div
              class="h-10 w-10 rounded-full flex items-center justify-center text-white font-bold text-sm"
              style="background-color: ${avatarColor}"
            >
              ${initials}
            </div>
            <div class="ml-4">
              <div class="text-sm font-medium text-gray-900">
                ${customer.fullName}
              </div>
              <div class="text-sm text-gray-500">${customer.email}</div>
              <div class="text-sm text-gray-500">${
                customer.phone || "N/A"
              }</div>
            </div>
          </div>
        </td>
        <td class="px-6 py-4 whitespace-nowrap">
          ${getCustomerTypeBadge(customer.customerType)}
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
          ${customer.bookingCount} tour
        </td>
        <td
          class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900"
        >
          ${formatCurrency(customer.totalSpent)}
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
          ${formatDate(customer.lastBookingDate)}
        </td>
        <td
          class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2"
        >
          <button class="text-blue-600 hover:text-blue-900" onclick="event.stopPropagation(); viewCustomerDetail('${
            customer._id
          }')">
            Xem
          </button>
        </td>
      </tr>
    `;

      customerList.innerHTML += row;
    });
  };

  // Render pagination
  const renderPagination = (page, pages, total) => {
    const pagination = document.getElementById("pagination");
    pagination.innerHTML = "";

    if (pages <= 1) return;

    // Previous button
    if (page > 1) {
      const prevBtn = document.createElement("button");
      prevBtn.className =
        "px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-50";
      prevBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
      prevBtn.onclick = () => {
        currentPage = page - 1;
        loadCustomers(currentPage, currentSegment, currentSearch);
      };
      pagination.appendChild(prevBtn);
    }

    // Page numbers
    for (let i = 1; i <= pages; i++) {
      const btn = document.createElement("button");
      btn.className =
        i === page
          ? "px-3 py-2 rounded-lg bg-blue-600 text-white"
          : "px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-50";
      btn.textContent = i;
      btn.onclick = () => {
        currentPage = i;
        loadCustomers(currentPage, currentSegment, currentSearch);
        window.scrollTo(0, 0);
      };
      pagination.appendChild(btn);
    }

    // Next button
    if (page < pages) {
      const nextBtn = document.createElement("button");
      nextBtn.className =
        "px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-50";
      nextBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
      nextBtn.onclick = () => {
        currentPage = page + 1;
        loadCustomers(currentPage, currentSegment, currentSearch);
      };
      pagination.appendChild(nextBtn);
    }
  };

  // View customer detail
  const viewCustomerDetail = (customerId) => {
    window.location.href = `/admin/customers/${customerId}`;
  };

  // Event listeners
  document.getElementById("segmentFilter").addEventListener("change", (e) => {
    currentSegment = e.target.value;
    currentPage = 1;
    loadCustomers(currentPage, currentSegment, currentSearch);
  });

  document.getElementById("searchInput").addEventListener("input", (e) => {
    currentSearch = e.target.value;
    currentPage = 1;
    loadCustomers(currentPage, currentSegment, currentSearch);
  });

  document.getElementById("resetFilter").addEventListener("click", () => {
    currentPage = 1;
    currentSegment = "all";
    currentSearch = "";
    document.getElementById("segmentFilter").value = "all";
    document.getElementById("searchInput").value = "";
    loadCustomers(currentPage, currentSegment, currentSearch);
  });

  // Load data on page load
  document.addEventListener("DOMContentLoaded", () => {
    loadStats();
    loadCustomers(currentPage, currentSegment, currentSearch);
  });
</script>
