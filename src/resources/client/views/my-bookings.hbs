<div class="min-h-screen flex flex-col">
  <!-- Main Content -->
  <main class="flex-1 max-w-6xl mx-auto w-full px-4 py-8">
    <h1 class="text-3xl font-bold text-gray-900 mb-8">
      Danh sách đơn đặt tour của tôi
    </h1>

    <div id="loading" class="flex justify-center items-center py-12">
      <div class="text-center">
        <div
          class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto"
        ></div>
        <p class="mt-4 text-gray-600">Đang tải danh sách...</p>
      </div>
    </div>

    <div id="content" class="hidden space-y-6">
      <!-- Filters and Search -->
      <div class="bg-white rounded-lg shadow-md p-6">
        <div class="flex flex-col sm:flex-row gap-4">
          <input
            type="text"
            id="search-box"
            placeholder="Tìm kiếm mã đơn hoặc tên tour..."
            class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
          />
          <select
            id="status-filter"
            class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
          >
            <option value="">Tất cả trạng thái</option>
            <option value="pending">Chờ xác nhận</option>
            <option value="confirmed">Đã xác nhận</option>
            <option value="completed">Hoàn thành</option>
          </select>
        </div>
      </div>

      <!-- Bookings Table/List -->
      <div id="bookings-container" class="space-y-4">
        <!-- Bookings will be loaded here -->
      </div>

      <!-- Empty State -->
      <div id="empty-state" class="hidden text-center py-12">
        <i class="bi bi-inbox text-4xl text-gray-400 block mb-4"></i>
        <h3 class="text-xl font-semibold text-gray-900 mb-2">
          Không có đơn đặt tour nào
        </h3>
        <p class="text-gray-600 mb-6">
          Bạn chưa có đơn đặt tour nào. Hãy tìm một tour yêu thích!
        </p>
        <a
          href="/"
          class="inline-block bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg"
        >
          Tìm tour
        </a>
      </div>
    </div>

    <!-- Error State -->
    <div id="error-state" class="hidden">
      <div class="bg-red-50 border border-red-200 rounded-lg p-8 text-center">
        <i
          class="bi bi-exclamation-circle text-red-600 text-4xl mb-4 block"
        ></i>
        <h3 class="text-xl font-semibold text-red-900 mb-2">Có lỗi xảy ra</h3>
        <p class="text-red-700 mb-6">
          Vui lòng thử lại sau hoặc liên hệ với hỗ trợ khách hàng.
        </p>
        <a
          href="/"
          class="inline-block bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-6 rounded-lg"
        >
          Quay lại trang chủ
        </a>
      </div>
    </div>
  </main>
</div>

<script>
  let bookings = [];
  let filteredBookings = [];

  async function loadBookings() {
    try {
      const response = await fetch("/api/bookings/user/bookings");
      const result = await response.json();

      if (!result.success) {
        showError();
        return;
      }

      bookings = result.data || [];
      filteredBookings = bookings;
      displayBookings();
    } catch (error) {
      console.error("Error:", error);
      showError();
    }
  }

  function displayBookings() {
    const container = document.getElementById("bookings-container");
    const emptyState = document.getElementById("empty-state");

    if (filteredBookings.length === 0) {
      container.innerHTML = "";
      emptyState.classList.remove("hidden");
      return;
    }

    emptyState.classList.add("hidden");
    container.innerHTML = filteredBookings
      .map((booking) => createBookingCard(booking))
      .join("");

    // Add click handlers
    document.querySelectorAll(".view-details-btn").forEach((btn) => {
      btn.addEventListener("click", (e) => {
        const bookingId = e.target.dataset.bookingId;
        window.location.href = `/booking-details/${bookingId}`;
      });
    });
  }

  function createBookingCard(booking) {
    const tour = booking.tourId;
    const statusBadge = getStatusBadge(booking.bookingStatus);
    const paymentBadge = getPaymentStatusBadge(booking.paymentStatus);

    return `
        <div class="bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow">
          <div class="p-6">
            <div class="flex justify-between items-start mb-4">
              <div>
                <h3 class="text-lg font-semibold text-gray-900">${
                  tour.name
                }</h3>
                <p class="text-sm text-gray-500">Mã đơn: <span class="font-mono font-semibold">${
                  booking.bookingCode
                }</span></p>
              </div>
              <div class="flex gap-2">
                ${statusBadge}
                ${paymentBadge}
              </div>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4 py-4 border-t border-b border-gray-200">
              <div>
                <p class="text-sm text-gray-500">Ngày khởi hành</p>
                <p class="font-semibold text-gray-900">${formatDate(
                  booking.departureDate
                )}</p>
              </div>
              <div>
                <p class="text-sm text-gray-500">Số khách</p>
                <p class="font-semibold text-gray-900">${
                  booking.numberOfPeople
                } người</p>
              </div>
              <div>
                <p class="text-sm text-gray-500">Tổng tiền</p>
                <p class="font-semibold text-blue-600">${formatPrice(
                  booking.totalAmount
                )}₫</p>
              </div>
              <div>
                <p class="text-sm text-gray-500">Ngày đặt</p>
                <p class="font-semibold text-gray-900">${formatDate(
                  booking.createdAt
                )}</p>
              </div>
            </div>

            <div class="flex gap-3">
              <button
                class="view-details-btn flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors"
                data-booking-id="${booking._id}"
              >
                <i class="bi bi-eye mr-2"></i>Xem chi tiết
              </button>
              <a
                href="${tour.slug ? `/booking/${tour.slug}` : "#"}"
                class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-lg text-center transition-colors"
              >
                <i class="bi bi-arrow-repeat mr-2"></i>Đặt lại
              </a>
            </div>
          </div>
        </div>
      `;
  }

  function getStatusBadge(status) {
    const badges = {
      pre_booking:
        '<span class="bg-red-100 text-red-800 px-3 py-1 rounded-full text-xs font-semibold">Đang hủy</span>',
      pending:
        '<span class="bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full text-xs font-semibold">Chờ xác nhận</span>',
      confirmed:
        '<span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-xs font-semibold">Đã xác nhận</span>',
      refund_requested:
        '<span class="bg-amber-100 text-amber-800 px-3 py-1 rounded-full text-xs font-semibold">Chờ hoàn tiền</span>',
      refunded:
        '<span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-xs font-semibold">Đã hoàn tiền</span>',
      completed:
        '<span class="bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-xs font-semibold">Hoàn thành</span>',
      cancelled:
        '<span class="bg-red-100 text-red-800 px-3 py-1 rounded-full text-xs font-semibold">Đã hủy</span>',
    };
    return badges[status] || status;
  }

  function getPaymentStatusBadge(status) {
    const badges = {
      pending:
        '<span class="bg-orange-100 text-orange-800 px-3 py-1 rounded-full text-xs font-semibold">Chờ TT</span>',
      paid: '<span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-xs font-semibold">Đã TT</span>',
      partial:
        '<span class="bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-xs font-semibold">TT 1 phần</span>',
      refunded:
        '<span class="bg-gray-100 text-gray-800 px-3 py-1 rounded-full text-xs font-semibold">Hoàn tiền</span>',
    };
    return badges[status] || status;
  }

  function formatDate(dateStr) {
    const options = { year: "numeric", month: "2-digit", day: "2-digit" };
    return new Date(dateStr).toLocaleDateString("vi-VN", options);
  }

  function formatPrice(price) {
    return new Intl.NumberFormat("vi-VN").format(Math.round(price));
  }

  function showError() {
    document.getElementById("loading").classList.add("hidden");
    document.getElementById("error-state").classList.remove("hidden");
  }

  // Search and Filter
  document.getElementById("search-box").addEventListener("input", (e) => {
    const query = e.target.value.toLowerCase();
    filteredBookings = bookings.filter(
      (b) =>
        b.bookingCode.toLowerCase().includes(query) ||
        b.tourId.name.toLowerCase().includes(query)
    );
    displayBookings();
  });

  document.getElementById("status-filter").addEventListener("change", (e) => {
    const status = e.target.value;
    filteredBookings = status
      ? bookings.filter((b) => b.bookingStatus === status)
      : bookings;
    displayBookings();
  });

  // Load bookings on page load
  window.addEventListener("DOMContentLoaded", () => {
    loadBookings();
    document.getElementById("loading").classList.add("hidden");
    document.getElementById("content").classList.remove("hidden");
  });
</script>
